<link rel="import" href="/polymer/iron-icon/iron-icon.html">
<link rel="import" href="/polymer/iron-icons/iron-icons.html">
<link rel="import" href="/polymer/paper-button/paper-button.html">

<dom-module id="friend-search">
<style include="common-style">
:host{
	display: block;
	padding-top: 100px;
}
.search-input{
	margin-top: 40px;
	height: 40px;
	border-radius: 3px;
	overflow: hidden;
	@apply(--shadow-elevation-2dp);
}
.search-input input{
	border: 0;
	outline : 0;
	display: block;
	width: 100%;
	height: 100%;
	padding-left: 10px;
}
.search-input button{
	position: absolute;
	right: 5px;
	top: 5px;
	width: 30px;
	height: 30px;
	cursor: pointer;
	opacity: .4;
	color: #6a96ff;
	background: none;
	border: 0;
	outline: 0;
	@apply(--transition-style);
}
.search-input button:hover{
	opacity: .7;
}
.search-input button:active{
	opacity: 1;
}
.search-input button iron-icon{
	width: 100%;
	height: 100%;
}
.results {
	margin-top: 50px;
	border-radius: 3px;
	overflow: hidden;
	@apply(--shadow-elevation-2dp);
	border: 1px #ddd solid;
}
.results > li:not(.nf) {
	display: flex;
	height: 40px;
	line-height: 40px;
	background: #fff;
	border-bottom: 1px #ddd solid;
}
.results > li:first-child{
	height: 50px;
	line-height: 50px;
	background: #66b0ff;
	color: #fff;
	border-bottom: 0;
}
.results > li:last-of-type{
	border-bottom: 0;
}
.results > li:not(.nf) > * {
	text-align: center;
}
.results > li .name {
	flex-basis: 20%;
}
.results > li .account {
	flex-basis: 65%;
}
.results > li .invite {
	flex-basis: 15%;
}
.results > li .invite paper-button{
	width: 80%;
	height: 80%;
	background: #ff6262;
	color: #fff;
}
.results > li.nf{
	color: rgba(0,0,0,.4);
	background: #fff;
	height: 250px;
}
.results > li.nf > iron-icon{
	width: 180px;
	height: 180px;
}
</style>
<template>
	<!-- 검색 AJAX -->
	<iron-ajax id="searchHTTP" url="/friend/searchuser" params="[[searchKeyword]]" last-response="{{users}}"></iron-ajax>
	<!-- 초대 AJAX -->
	<iron-ajax id="inviteHTTP" url="/friend/invite" params="[[inviteParam]]" on-response="invitedUser"></iron-ajax>
	<!-- 유저 검색 폼 -->
	<form class="search-input" on-submit="searchFriend">
		<input type="text" value="{{keyword::input}}" placeholder="검색할 친구의 이메일이나 아이디 혹은 이름을 입력하세요.">
		<button>
			<iron-icon icon="icons:search"></iron-icon>
		</button>
	</form>
	<!-- 검색 결과 유저 리스트 -->
	<ul class="results">
		<li>
			<div class="name">이름</div>
			<div class="account">계정</div>
			<div class="invite">초대하기</div>
		</li>
		<template is="dom-if" if="{{!users.length}}">
			<li class="nf tac">
				<iron-icon icon="icons:search"></iron-icon>
				<h2>검색하면 목록이 나옵니다.</h2>
			</li>
		</template>
		<template is="dom-repeat" items="{{users}}">
			<li>
				<div class="name">{{item.name}}</div>
				<div class="account">{{item.account}}</div>
				<div class="invite">
					<paper-button raised invite-idx$="{{item.idx}}" on-tap="inviteFriend">초대하기</paper-button>
				</div>
			</li>
		</template>
	</ul>
</template>
<script>
	Polymer({
		is : "friend-search",
		invitedUser : function(e) { // 유저에게 초대 메세지를 보낸후의 이벤트
			var result = e.detail.response;
			console.log(result);
			if(result.result) {
				Polymer.app.toast.alert("친구 초대에 성공했습니다.");
			}else {
				Polymer.app.toast.alert("존재하지 않는 유저이거나 이미 초대한 상태입니다.", "/friend/list")
			}
		},
		inviteFriend : function(e) { // 유저에게 친구 초대 메세지를 보낸다.
			var inviteIdx = e.target.getAttribute("invite-idx");
			this.inviteParam = {
				inviteIdx : inviteIdx
			};
			this.inviteHTTP.generateRequest();
		},
		ready : function() {
			this.searchHTTP = this.$.searchHTTP;
			this.inviteHTTP = this.$.inviteHTTP;

			this.searchKeyword = {};
			this.users = [];
			window.sub = this;
		},
		searchFriend : function(e) {
			e.preventDefault();
			var keyword = this.keyword ? this.keyword : "";
			keyword = keyword.trim();
			if(keyword === "") {
				Polymer.app.toast.alert("검색할 키워드를 입력하세요.");
				return;
			}
			this.searchKeyword['keyword'] = keyword;

			this.searchHTTP.generateRequest();
		}
	});
</script>
</dom-module>